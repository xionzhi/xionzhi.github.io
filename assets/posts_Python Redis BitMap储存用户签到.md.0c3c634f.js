import{_ as s,o as n,c as a,a as l}from"./app.a366ee3d.js";const i=JSON.parse('{"title":"Python Redis BitMap储存用户签到","description":"","frontmatter":{"title":"Python Redis BitMap储存用户签到","author":"xionzhi","date":"2022-12-21","showAccessNumber":true,"categories":["测试"],"tags":["标签1","标签2","标签3"],"excerpt":"Redis提供的数据类型位图`BitMap`，每个`bit`位对应`0`和`1`两个状态。虽然内部还是采用`String`类型存储，但Redis提供了一些指令用于直接操作`BitMap`，可以把它看作一个`bit`数组，数组的下标就是偏移量。\\n它的优点是内存开销小，效率高且操作简单，很适合用于签到这类场景。缺点在于位计算和位表示数值的局限。如果要用位来做业务数据记录，就不要在意value的值。"},"headers":[],"relativePath":"posts/Python Redis BitMap储存用户签到.md"}'),p={name:"posts/Python Redis BitMap储存用户签到.md"},o=l(`<nav class="table-of-contents"><ul></ul></nav><p>Redis提供的数据类型位图<code>BitMap</code>，每个<code>bit</code>位对应<code>0</code>和<code>1</code>两个状态。虽然内部还是采用<code>String</code>类型存储，但Redis提供了一些指令用于直接操作<code>BitMap</code>，可以把它看作一个<code>bit</code>数组，数组的下标就是偏移量。</p><p>它的优点是内存开销小，效率高且操作简单，很适合用于签到这类场景。缺点在于位计算和位表示数值的局限。如果要用位来做业务数据记录，就不要在意value的值。</p><h4 id="bitmap指令说明" tabindex="-1">bitmap指令说明 <a class="header-anchor" href="#bitmap指令说明" aria-hidden="true">#</a></h4><ol><li><p><strong>BITCOUNT</strong></p><p>计算给定字符串中，被设置为 1 的比特位的数量</p></li><li><p><strong>BITFIELD</strong></p><p>在一次调用中同时对多个位范围进行操作</p></li><li><p><strong>BITFIELD_RO</strong></p><p>BITFIELD的只读版本，redis&gt;=6.0</p></li><li><p><strong>BITOP</strong></p><p>对一个或多个保存二进制位的字符串 key 进行位元操作</p></li><li><p><strong>BITPOS</strong></p><p>返回位图中第一个值为 bit 的二进制位的位置</p></li><li><p><strong>GETBIT</strong></p><p>对 key 所储存的字符串值，获取指定偏移量上的位(bit)</p></li><li><p><strong>SETBIT</strong></p><p>对 key 所储存的字符串值，设置或清除指定偏移量上的位(bit)</p></li></ol><h4 id="关于签到实现" tabindex="-1">关于签到实现 <a class="header-anchor" href="#关于签到实现" aria-hidden="true">#</a></h4><p>如果按年存储，Key的格式为 <code>u:sign:{uid}:{yyyy}</code>，value最大长度为<code>46字节</code>(368位)闰年天数为<code>366</code>天。</p><p>如果每月要重置连续签到次数，最简单的方式是按用户每月存一条签到数据。Key的格式为 <code>u:sign:{uid}:{yyyyMM}</code>，而Value则采用长度为<code>4个字节</code>的(32位)最大月份天数是<code>31</code>天。</p><p><code>BitMap</code>的每一位代表一天的签到，<code>1</code>表示已签，<code>0</code>表示未签。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;"># 偏移量OFFSET是从0开始的 实际操作日期减1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 设置2022年10月21日签到</span></span>
<span class="line"><span style="color:#A6ACCD;">SETBIT u:sign:1:202210 20 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 查询2022年10月21日是否签到</span></span>
<span class="line"><span style="color:#A6ACCD;">GETBIT u:sign:1:202210 20</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 统计10月的总签到次数</span></span>
<span class="line"><span style="color:#A6ACCD;">BITCOUNT u:sign:1:202210</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 获取10月的签到详情</span></span>
<span class="line"><span style="color:#A6ACCD;">BITFIELD u:sign:1:202210 GET u31 0</span></span>
<span class="line"><span style="color:#A6ACCD;">BITFIELD_RO u:sign:1:202210 GET u31 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 获取10月最早签到日期 未签到日期</span></span>
<span class="line"><span style="color:#A6ACCD;">BITPOS u:sign:1:202210 1</span></span>
<span class="line"><span style="color:#A6ACCD;">BITPOS u:sign:1:202210 0</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h4 id="位图运算原理" tabindex="-1">位图运算原理 <a class="header-anchor" href="#位图运算原理" aria-hidden="true">#</a></h4><p>bit数据右移1位再左移1位可以得到什么？</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;"># 二进制数据511</span></span>
<span class="line"><span style="color:#A6ACCD;">111111111</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 右移1位</span></span>
<span class="line"><span style="color:#A6ACCD;">011111111</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 再左移1位</span></span>
<span class="line"><span style="color:#A6ACCD;">111111110</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 右移再左移与原数据不同，可以判断最后一位数据是1，即已签到</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>未签到状态</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;"># 二进制数据510</span></span>
<span class="line"><span style="color:#A6ACCD;">111111110</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 右移1位</span></span>
<span class="line"><span style="color:#A6ACCD;">011111111</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 再左移1位</span></span>
<span class="line"><span style="color:#A6ACCD;">111111110</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 右移再左移与原数据相同，可以判断最后一位数据是0，即已未签到</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>原地右移之后最后一位则是前一天的签到状态</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#676E95;"># 连续的签到数据</span></span>
<span class="line"><span style="color:#A6ACCD;">101010101</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;"># 原地右移 v &gt;&gt;= 1</span></span>
<span class="line"><span style="color:#A6ACCD;">10101010</span></span>
<span class="line"><span style="color:#A6ACCD;">1010101</span></span>
<span class="line"><span style="color:#A6ACCD;">101010</span></span>
<span class="line"><span style="color:#A6ACCD;">10101</span></span>
<span class="line"></span></code></pre></div><h4 id="python代码实现" tabindex="-1">python代码实现 <a class="header-anchor" href="#python代码实现" aria-hidden="true">#</a></h4><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;">redis bitmap 用户签到</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">Python 3.8.13</span></span>
<span class="line"><span style="color:#676E95;">redis==4.3.4</span></span>
<span class="line"><span style="color:#676E95;">redis_version:7.0.4</span></span>
<span class="line"><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> typing </span><span style="color:#89DDFF;">as</span><span style="color:#A6ACCD;"> t</span></span>
<span class="line"><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> calendar </span><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> monthrange</span></span>
<span class="line"><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> datetime </span><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> datetime</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> timedelta</span></span>
<span class="line"><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> operator </span><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> rshift</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> lshift</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> irshift</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">from</span><span style="color:#A6ACCD;"> redis </span><span style="color:#89DDFF;">import</span><span style="color:#A6ACCD;"> Redis</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">UserSign</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__init__</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">host</span><span style="color:#89DDFF;">=None,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">port</span><span style="color:#89DDFF;">=None,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">db</span><span style="color:#89DDFF;">=None,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">decode_responses</span><span style="color:#89DDFF;">=None):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;">        now: 2022-10-20</span></span>
<span class="line"><span style="color:#676E95;">        bitmap.len: 0 * 20</span></span>
<span class="line"><span style="color:#676E95;">        set 2-4 14-20</span></span>
<span class="line"><span style="color:#676E95;">        bitmap.info: 01111000000001111111 -&gt; int10(491647)</span></span>
<span class="line"><span style="color:#676E95;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">host</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> host </span><span style="color:#89DDFF;">or</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">localhost</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">port</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> port </span><span style="color:#89DDFF;">or</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6379</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">db</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> db </span><span style="color:#89DDFF;">or</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">decode_responses</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> decode_responses </span><span style="color:#89DDFF;">or</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">True</span></span>
<span class="line"><span style="color:#A6ACCD;">        self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">redis_store</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Redis</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">host</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">host</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">                                 </span><span style="color:#A6ACCD;">port</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">port</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">                                 </span><span style="color:#A6ACCD;">db</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">db</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">                                 </span><span style="color:#A6ACCD;">decode_responses</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">decode_responses</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#FFCB6B;">staticmethod</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_build_sign_key</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">uid</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">date</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> datetime</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;u:sign:</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">uid</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">:</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">strftime</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">%Y%m</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">do_sign</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">uid</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">date</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> datetime</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;">        用户签到</span></span>
<span class="line"><span style="color:#676E95;">        :return 之前的签到状态</span></span>
<span class="line"><span style="color:#676E95;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        offset</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> date</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">day</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">redis_store</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setbit</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_build_sign_key</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">uid</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> date</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> offset</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">check_sign</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">uid</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">date</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> datetime</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;">        检查签到</span></span>
<span class="line"><span style="color:#676E95;">        :return 当前的签到状态</span></span>
<span class="line"><span style="color:#676E95;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        offset</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> date</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">day</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">redis_store</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getbit</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_build_sign_key</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">uid</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> date</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> offset</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_sign_count</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">uid</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">date</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> datetime</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;">        签到次数</span></span>
<span class="line"><span style="color:#676E95;">        :return 当前的签到次数</span></span>
<span class="line"><span style="color:#676E95;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">redis_store</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bitcount</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_build_sign_key</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">uid</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> date</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_continuous_sign_count</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">uid</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">date</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> datetime</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;">        BITFIELD 命令可以在一次调用中同时对多个位范围进行操作</span></span>
<span class="line"><span style="color:#676E95;">        连续签到次数</span></span>
<span class="line"><span style="color:#676E95;">        :return 当月连续签到次数</span></span>
<span class="line"><span style="color:#676E95;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        sign_count</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        bf </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">redis_store</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bitfield</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_build_sign_key</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">uid</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> date</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">        bf</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;u</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">date</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">day</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 取1号到当天的签到状态</span></span>
<span class="line"><span style="color:#A6ACCD;">        result</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">List</span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> bf</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">not</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sign_count</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        v</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">date</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">day</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">lshift</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">rshift</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">v</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> v</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># (v &gt;&gt; 1 &lt;&lt; 1)</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 右移然后左移等于自己 即低位为0 且非当天说明连续签到中断</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;">break</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">else</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                sign_count </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            v </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">irshift</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">v</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># v &gt;&gt;= 1  # 原地右移 往前查询</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sign_count</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_first_sign_date</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">uid</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">date</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> datetime</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Union</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">datetime</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">None]:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;">        获取当月首次签到日期</span></span>
<span class="line"><span style="color:#676E95;">        :return: 首次签到日期</span></span>
<span class="line"><span style="color:#676E95;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        pos</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">redis_store</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bitpos</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_build_sign_key</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">uid</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> date</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> pos </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> date </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">timedelta</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">days</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">date</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">day</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">-</span><span style="color:#82AAFF;"> pos </span><span style="color:#89DDFF;">-</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_sign_info_v2</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">uid</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">date</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> datetime</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Dict</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;">        获取当月签到情况, 多次IO速度慢逻辑简单</span></span>
<span class="line"><span style="color:#676E95;">        :return: Key为签到日期，Value为签到状态的Map</span></span>
<span class="line"><span style="color:#676E95;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        sign_map</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">dict</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">monthrange</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">date</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">year</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> date</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">month</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]):</span></span>
<span class="line"><span style="color:#A6ACCD;">            i_date </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">replace</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">day</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">timedelta</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">days</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">i</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            sign_map</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i_date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">strftime</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%Y%m</span><span style="color:#F78C6C;">%d</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">check_sign</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">uid</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> i_date</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sign_map</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_sign_info</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">self</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">uid</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">date</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> datetime</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Dict</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#676E95;">        获取当月签到情况</span></span>
<span class="line"><span style="color:#676E95;">        :return: Key为签到日期，Value为签到状态的Map</span></span>
<span class="line"><span style="color:#676E95;">        </span><span style="color:#89DDFF;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        sign_map</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">dict</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#A6ACCD;">        month_day</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">monthrange</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">date</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">year</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> date</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">month</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        bf </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">redis_store</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bitfield</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_build_sign_key</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">uid</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> date</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">        bf</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&#39;u</span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">month_day</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># 取整月的签到状态</span></span>
<span class="line"><span style="color:#A6ACCD;">        result</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> t</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">List</span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">int</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> bf</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">execute</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">not</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sign_map</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        v</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">range</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">month_day</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">            sign_map</span><span style="color:#89DDFF;">[(</span><span style="color:#A6ACCD;">date </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">timedelta</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">i </span><span style="color:#89DDFF;">-</span><span style="color:#82AAFF;"> date</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">day</span><span style="color:#89DDFF;">)).</span><span style="color:#82AAFF;">strftime</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%Y%m</span><span style="color:#F78C6C;">%d</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\\</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#82AAFF;">lshift</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">rshift</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">v</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> v</span></span>
<span class="line"><span style="color:#A6ACCD;">            v </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">irshift</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">v</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;"># v &gt;&gt;= 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> sign_map</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> __name__ </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">__main__</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    us </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">UserSign</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    _uid </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">    _date </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> datetime</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># 签到 now 20</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># for i in range(2, 6):  # set 1 - 5</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">#     r_date = _date.replace(day=i)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">#     print(r_date, us.do_sign(_uid, r_date))</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">#</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># for i in range(14, _date.day + 1):  # set 5 - now</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">#     r_date = _date.replace(day=i)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;">#     print(r_date, us.do_sign(_uid, r_date))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># 签到判断</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># print(us.check_sign(_uid, _date))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># 当月总签到数</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># print(us.get_sign_count(_uid, _date))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># 当月最早签到日期</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># print(us.get_first_sign_date(_uid, _date))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># 当月连续签到次数</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># print(us.get_continuous_sign_count(_uid, _date))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># 当月签到详情</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># print(us.get_sign_info(_uid, _date))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># 当月签到详情v2</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;"># print(us.get_sign_info_v2(_uid, _date))</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><h4 id="bitmap应用总结" tabindex="-1">bitmap应用总结 <a class="header-anchor" href="#bitmap应用总结" aria-hidden="true">#</a></h4><p>位图优点是内存开销小，效率高且操作简单；缺点是位计算和位表示数值的局限。String类型最大长度为512M。 注意SETBIT时的偏移量，当偏移量很大时，可能会有较大耗时。 位图不是绝对的好，有时可能更浪费空间。</p><p>参考：<br><a href="https://redis.io/commands/bitfield/" target="_blank" rel="noreferrer">[Redis.io Docs] redis.io/commands</a></p>`,22),e=[o];function t(c,r,D,F,y,A){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{i as __pageData,d as default};
